<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Setting up a Kubernetes Cluster using Kubespray on VirtualBox with Ubuntu 22.04</title><meta name="robots" content="follow, index"/><meta name="description" content=""/><meta property="og:url" content="https://demian9k.github.io/blog/set-up-k8s-cluster-kubespray-on-virtualbox-ubuntu2204"/><meta property="og:type" content="article"/><meta property="og:site_name" content="demian11k"/><meta property="og:description" content=""/><meta property="og:title" content="Setting up a Kubernetes Cluster using Kubespray on VirtualBox with Ubuntu 22.04"/><meta property="og:image" content="https://demian9k.github.io/static/images/twitter-card.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site"/><meta name="twitter:title" content="Setting up a Kubernetes Cluster using Kubespray on VirtualBox with Ubuntu 22.04"/><meta name="twitter:description" content=""/><meta name="twitter:image" content="https://demian9k.github.io/static/images/twitter-card.png"/><link rel="canonical" href="https://demian9k.github.io/blog/set-up-k8s-cluster-kubespray-on-virtualbox-ubuntu2204/"/><meta property="article:published_time" content="2023-06-04T02:02:11.000Z"/><meta property="article:modified_time" content="2023-06-04T00:00:00.000Z"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://demian9k.github.io/blog/set-up-k8s-cluster-kubespray-on-virtualbox-ubuntu2204"
  },
  "headline": "Setting up a Kubernetes Cluster using Kubespray on VirtualBox with Ubuntu 22.04",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://demian9k.github.io/static/images/twitter-card.png"
    }
  ],
  "datePublished": "2023-06-04T02:02:11.000Z",
  "dateModified": "2023-06-04T00:00:00.000Z",
  "author": {
    "@type": "Person",
    "name": "demian11k"
  },
  "publisher": {
    "@type": "Organization",
    "name": "demian11k",
    "logo": {
      "@type": "ImageObject",
      "url": "https://demian9k.github.io/static/images/logo.png"
    }
  },
  "description": ""
}</script><meta name="next-head-count" content="21"/><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preload" href="/_next/static/css/94ea37d977b78d30.css" as="style"/><link rel="stylesheet" href="/_next/static/css/94ea37d977b78d30.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-781a92acf59ed6b5.js" defer=""></script><script src="/_next/static/chunks/main-bfc1a3b6dd286443.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e22266d47111418b.js" defer=""></script><script src="/_next/static/chunks/140-77b8ab5a870d524b.js" defer=""></script><script src="/_next/static/chunks/574-40cb695d6b511631.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-48fd063b43fdbe6a.js" defer=""></script><script src="/_next/static/otfPwKwSsy3CYkkcjSJd6/_buildManifest.js" defer=""></script><script src="/_next/static/otfPwKwSsy3CYkkcjSJd6/_ssgManifest.js" defer=""></script><script src="/_next/static/otfPwKwSsy3CYkkcjSJd6/_middlewareManifest.js" defer=""></script></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex h-screen flex-col justify-between"><header class="flex items-center justify-between py-10"><div><a aria-label="demian11k" href="/"><div class="flex items-center justify-between"><div class="mr-3"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2740%27%20height=%2740%27/%3e"/></span><img alt="A" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="rounded-full object-cover object-center md:h-36 lg:h-48" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="A" srcSet="/_next/static/media/demian_avatar_logo.73bd1e6e.png?imwidth=48 1x, /_next/static/media/demian_avatar_logo.73bd1e6e.png?imwidth=96 2x" src="/_next/static/media/demian_avatar_logo.73bd1e6e.png?imwidth=96" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="rounded-full object-cover object-center md:h-36 lg:h-48" loading="lazy"/></noscript></span></div><div class="hidden h-6 text-2xl font-semibold leading-4 sm:block">demian11k</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/blog">Blog</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/projects">Projects</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="ml-1 mr-1 h-8 w-8 rounded p-1 sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-0 left-0 z-10 h-full w-full transform bg-gray-200 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><div class="flex justify-end"><button type="button" class="mr-5 mt-11 h-8 w-8 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/projects">Projects</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:hidden"><button aria-label="Scroll To Top" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div><header><div class="space-y-1 border-b border-gray-200 pb-10 text-center dark:border-gray-700"><dl><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2023-06-04T02:02:11.000Z">June 4, 2023</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Setting up a Kubernetes Cluster using Kubespray on VirtualBox with Ubuntu 22.04</h1></div></div></header><div class="divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:divide-y-0 " style="grid-template-rows:auto 1fr"><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose max-w-none pt-10 pb-8 dark:prose-dark"><h2 id="step1-vm-network-setup"><a href="#step1-vm-network-setup" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Step1. VM network setup</h2><h4 id="configure-virtualbox-host-only-network-cidr-manual"><a href="#configure-virtualbox-host-only-network-cidr-manual" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Configure VirtualBox host-only network CIDR (manual)</h4><ul><li>192.168.100.0/24</li></ul><h4 id="클러스터-노드가-될-호스트-목록"><a href="#클러스터-노드가-될-호스트-목록" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>클러스터 노드가 될 호스트 목록</h4><ul><li>myclusternode01</li><li>myclusternode02</li><li>myclusternode03</li></ul><p>각 host들은 첫번째 nic는 DHCP를 사용한 NAT가 적용된 것을 사용한다.</p><p>두번째 NIC는 host-only nic ip를 갖는다. 아래 내용은 /etc/hosts 파일에 등록된다.</p><p>windows host-only network의 nic는 192.168.100.100 으로 설정하여 windows host에서 각 myclusternode 의 host-only 네트워크에 연결할 수 있도록 한다.</p><h2 id="step2-setup-hosts"><a href="#step2-setup-hosts" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Step2. Setup hosts</h2><h3 id="register-hostnames"><a href="#register-hostnames" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>register hostnames</h3><p>각 호스트들을 이름으로 식별하도록 hosts에 등록한다. 모든 호스트에 등록되어야 한다.</p><div class="remark-code-title">/etc/hosts</div><div class="relative"><pre><code class="code-highlight"><span class="code-line">192.168.100.1 myclusternode01
</span><span class="code-line">192.168.100.2 myclusternode02
</span><span class="code-line">192.168.100.3 myclusternode03
</span></code></pre></div><h3 id="sudoers"><a href="#sudoers" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>sudoers</h3><p>sudo 명령어 사용시 비밀번호를 입력하지 않도록 sudoers 설정을 한다.</p><div class="remark-code-title">/etc/sudoers</div><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">demian <span class="token variable assign-left">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">)</span> NOPASSWD:ALL
</span></code></pre></div><h3 id="netplan에서-static-ip-설정"><a href="#netplan에서-static-ip-설정" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>netplan에서 static ip 설정</h3><div class="remark-code-title">/etc/netplan/00-installer-config.yaml</div><div class="relative"><pre><code class="code-highlight language-yaml"><span class="code-line"><span class="token atrule key">network</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">ethernets</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">enp0s3</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">dhcp4</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># NAT를 사용해 호스트의 인터넷 연결을 사용할 수 있도록 설정</span>
</span><span class="code-line">    <span class="token atrule key">enp0s8</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">addresses</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token punctuation">-</span> 192.168.100.1/24
</span><span class="code-line">      <span class="token atrule key">nameservers</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token atrule key">addresses</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>8.8.8.8<span class="token punctuation">,</span> 8.8.4.4<span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token atrule key">version</span><span class="token punctuation">:</span> <span class="token number">2</span>
</span></code></pre></div><h3 id="change-apt-sources-url"><a href="#change-apt-sources-url" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>change APT sources url</h3><p>더 빠른 의존성 파일 다운로드를 위해 기본값 apt source list를 변경한다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">&#x27;s/kr.archive.ubuntu.com/mirror.kakao.com/g&#x27;</span> /etc/apt/sources.list
</span></code></pre></div><h3 id="setup-ansible-dependencies"><a href="#setup-ansible-dependencies" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>setup ansible dependencies</h3><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token function">apt</span> update
</span><span class="code-line"><span class="token function">apt</span> upgrade
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># python3 설치</span>
</span><span class="code-line"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> python3-pip python3-setuptools python3-virtualenv -y
</span></code></pre></div><h3 id="configure-os-environment"><a href="#configure-os-environment" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>configure OS environment</h3><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token comment"># swap memory 끄기</span>
</span><span class="code-line"><span class="token function">sudo</span> swapoff -a
</span><span class="code-line"><span class="token comment"># 파일시스템 테이블(/etc/fstab) 에서 swap 관련 문자열을 삭제하여 swap 관련 기능을 disable 한다.</span>
</span><span class="code-line"><span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">&#x27;/swap/d&#x27;</span> /etc/fstab
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># 방화벽 disable</span>
</span><span class="code-line">systemctl stop ufw
</span><span class="code-line">systemctl disable ufw
</span></code></pre></div><hr/><p>이후 과정은 각 vm을 virtualbox에서 복제 후 myclusternode02, myclusternode03으로 복제후 진행한다.<br/>복제시 NIC의 Mac address는 새로 생성하도록 옵션을 주었다.</p><h3 id="change-node-ips-on-duplicated-vms"><a href="#change-node-ips-on-duplicated-vms" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>change node IPs on duplicated VMs</h3><p>복제된 vm의 netplan config의 network.ethernets.enp0s8.addresses에 호스트 목록에서 정의한 ip에 맞도록 설정을 변경한다.</p><div class="remark-code-title">/etc/netplan/00-installer-config.yaml</div><div class="relative"><pre><code class="code-highlight language-yaml"><span class="code-line"><span class="token atrule key">network</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token atrule key">ethernets</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token atrule key">enp0s3</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">dhcp4</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</span><span class="code-line">    <span class="token atrule key">enp0s8</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token atrule key">addresses</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token punctuation">-</span> 192.168.100.1/24
</span><span class="code-line">      <span class="token comment"># - 192.168.100.2/24  # myclusternode02의 경우</span>
</span><span class="code-line">      <span class="token comment"># - 192.168.100.3/24  # myclusternode03의 경우</span>
</span><span class="code-line">      <span class="token atrule key">nameservers</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token atrule key">addresses</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>8.8.8.8<span class="token punctuation">,</span> 8.8.4.4<span class="token punctuation">]</span>
</span><span class="code-line">  <span class="token atrule key">version</span><span class="token punctuation">:</span> <span class="token number">2</span>
</span></code></pre></div><h3 id="change-hostname-on-duplicated-vms"><a href="#change-hostname-on-duplicated-vms" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>change hostname on duplicated VMs</h3><p>아래 내용은 복제된 각 호스트에서 실행한다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token function">sudo</span> hostnamectl set-hostname myclusternode02
</span><span class="code-line">
</span><span class="code-line"><span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">&#x27;s/myclusternode01/myclusternode02/g&#x27;</span> /etc/hosts
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#변경 확인</span>
</span><span class="code-line"><span class="token function">cat</span> /etc/hostname
</span></code></pre></div><h3 id="generate-ssh-credentials"><a href="#generate-ssh-credentials" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>generate ssh credentials</h3><p>아래 내용은 모든 호스트에서 실행한다.</p><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line">ssh-keygen -t ed25519
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># 각 호스트에 ssh를 이용하여 접속할 수 있도록 credentials를 복사한다.</span>
</span><span class="code-line"><span class="token comment"># ssh node02  이런 방식으로 빠르게 접속 가능하게 된다.</span>
</span><span class="code-line">ssh-copy-id myclusternode01
</span><span class="code-line">ssh-copy-id myclusternode02
</span><span class="code-line">ssh-copy-id myclusternode03
</span></code></pre></div><h2 id="step3-setup-cluster-using-kubespray"><a href="#step3-setup-cluster-using-kubespray" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Step3. setup cluster using kubespray</h2><p>아래 항목은 control-plane 노드 중 한 곳에서 실행한다.</p><h3 id="setup-kubespray-dependencies"><a href="#setup-kubespray-dependencies" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>setup kubespray dependencies</h3><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token function">git</span> clone -b release-2.22 --single-branch https://github.com/kubernetes-sigs/kubespray
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># https://github.com/kubernetes-sigs/kubespray/blob/master/docs/ansible.md#installing-ansible</span>
</span><span class="code-line"><span class="token variable assign-left">VENVDIR</span><span class="token operator">=</span>kubespray-venv
</span><span class="code-line"><span class="token variable assign-left">KUBESPRAYDIR</span><span class="token operator">=</span>kubespray
</span><span class="code-line"><span class="token variable assign-left">ANSIBLE_VERSION</span><span class="token operator">=</span><span class="token number">2.12</span> <span class="token comment"># 앤서블 버전은 python 2.7,3.5-3.9 이면 2.11, 3.8 위로는 2.12이 Compatibility가 있다</span>
</span><span class="code-line">virtualenv  --python<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">which</span> python3<span class="token variable">)</span></span> <span class="token variable">$VENVDIR</span>
</span><span class="code-line"><span class="token builtin class-name">source</span> <span class="token variable">$VENVDIR</span>/bin/activate
</span><span class="code-line"><span class="token builtin class-name">cd</span> <span class="token variable">$KUBESPRAYDIR</span>
</span><span class="code-line">pip <span class="token function">install</span> -U -r requirements-<span class="token variable">$ANSIBLE_VERSION</span>.txt
</span></code></pre></div><h3 id="building-ansible-inventory-file"><a href="#building-ansible-inventory-file" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>building ansible inventory file</h3><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token comment"># Copy ``inventory/sample`` as ``inventory/mycluster``</span>
</span><span class="code-line"><span class="token comment"># sample 인벤토리 템플릿을 복사한다.</span>
</span><span class="code-line"><span class="token function">cp</span> -rfp inventory/sample inventory/mycluster
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Update Ansible inventory file with inventory builder</span>
</span><span class="code-line"><span class="token comment"># IPS로 지정한 host ip 목록을 매개변수로 인벤토리 빌더를 실행하여 hosts.yaml 파일을 만든다.</span>
</span><span class="code-line"><span class="token comment"># (hosts.yaml 파일은 sample 인벤토리 템플릿엔 존재하진 않는다.)</span>
</span><span class="code-line"><span class="token comment"># HOST_PREFIX는 노드 번호 앞에 붙일 이름을 의미한다. 아래 이름처럼 설정하면</span>
</span><span class="code-line"><span class="token comment"># myclusternode1, myclusternode2, myclusternode3 처럼 cluster node 이름과 각 호스트의 hostname이 변경된다.</span>
</span><span class="code-line"><span class="token comment"># 기존 hostname을 그대로 사용하려면 USE_REAL_HOSTNAME=true 로 변수를 set한다.</span>
</span><span class="code-line"><span class="token comment"># KUBE_CONTROL_HOSTS 값은 설치하는 노드 중 몇 개를 control-plane으로 사용할 것인지를 결정하는 변수이며, 기본값은 2다.</span>
</span><span class="code-line"><span class="token builtin class-name">declare</span> -a <span class="token variable assign-left">IPS</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">192.168</span>.100.1 <span class="token number">192.168</span>.100.2 <span class="token number">192.168</span>.100.3<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token variable assign-left">HOST_PREFIX</span><span class="token operator">=</span>myclusternode <span class="token variable assign-left">CONFIG_FILE</span><span class="token operator">=</span>inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py <span class="token variable">${IPS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># debug 모드가 기본값으로 켜져 있어 아래처럼 어떤 값들이 hosts.yaml에 추가되는지 stdout 된다.</span>
</span><span class="code-line"><span class="token comment"># DEBUG: Adding group all</span>
</span><span class="code-line"><span class="token comment"># DEBUG: Adding group kube_control_plane</span>
</span><span class="code-line"><span class="token comment"># DEBUG: Adding group kube_node</span>
</span><span class="code-line"><span class="token comment"># DEBUG: Adding group etcd</span>
</span><span class="code-line"><span class="token comment"># DEBUG: Adding group k8s_cluster</span>
</span><span class="code-line"><span class="token comment"># DEBUG: Adding group calico_rr</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode1 to group all</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode2 to group all</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode3 to group all</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode1 to group etcd</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode2 to group etcd</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode3 to group etcd</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode1 to group kube_control_plane</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode2 to group kube_control_plane</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode1 to group kube_node</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode2 to group kube_node</span>
</span><span class="code-line"><span class="token comment"># DEBUG: adding host myclusternode3 to group kube_node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Review and change parameters under ``inventory/mycluster/group_vars``</span>
</span><span class="code-line"><span class="token function">cat</span> inventory/mycluster/group_vars/all/all.yml
</span><span class="code-line"><span class="token function">cat</span> inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml
</span></code></pre></div><h3 id="setting-kubespray-inventory-variable"><a href="#setting-kubespray-inventory-variable" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>setting kubespray inventory variable</h3><div class="remark-code-title">inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml</div><div class="relative"><pre><code class="code-highlight language-yaml"><span class="code-line"><span class="token comment"># configure arp_ignore and arp_announce to avoid answering ARP queries from kube-ipvs0 interface</span>
</span><span class="code-line"><span class="token comment"># must be set to true for MetalLB to work</span>
</span><span class="code-line"><span class="token comment">#METAL_LB 사용 예정이므로 true로 변경</span>
</span><span class="code-line"><span class="token atrule key">kube_proxy_strict_arp</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">## docker for docker, crio for cri-o and containerd for containerd.</span>
</span><span class="code-line"><span class="token atrule key">container_manager</span><span class="token punctuation">:</span> containerd
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># audit log for kubernetes</span>
</span><span class="code-line"><span class="token atrule key">kubernetes_audit</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</span></code></pre></div><h3 id="run-playbook-to-install-k8s-cluster"><a href="#run-playbook-to-install-k8s-cluster" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>run playbook to install k8s cluster</h3><div class="relative"><pre><code class="language-bash code-highlight"><span class="code-line"><span class="token comment"># Clean up old Kubernete cluster with Ansible Playbook - run the playbook as root</span>
</span><span class="code-line"><span class="token comment"># The option `--become` is required, as for example cleaning up SSL keys in /etc/,</span>
</span><span class="code-line"><span class="token comment"># uninstalling old packages and interacting with various systemd daemons.</span>
</span><span class="code-line"><span class="token comment"># Without --become the playbook will fail to run!</span>
</span><span class="code-line"><span class="token comment"># And be mind it will remove the current kubernetes cluster (if it&#x27;s running)!</span>
</span><span class="code-line"><span class="token comment"># 이전에 설치한 흔적을 삭제하기 위해 hosts.yaml의 호스트 목록을 대상으로 reset playbook을 실행한다.</span>
</span><span class="code-line">ansible-playbook -i inventory/mycluster/hosts.yaml  --become --become-user<span class="token operator">=</span>root reset.yml
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Deploy Kubespray with Ansible Playbook - run the playbook as root</span>
</span><span class="code-line"><span class="token comment"># The option `--become` is required, as for example writing SSL keys in /etc/,</span>
</span><span class="code-line"><span class="token comment"># installing packages and interacting with various systemd daemons.</span>
</span><span class="code-line"><span class="token comment"># Without --become the playbook will fail to run!</span>
</span><span class="code-line"><span class="token comment"># hosts.yaml의 호스트 목록을 대상으로 cluster를 설치하기 위해 cluster playbook을 실행한다.</span>
</span><span class="code-line">ansible-playbook -i inventory/mycluster/hosts.yaml  --become --become-user<span class="token operator">=</span>root cluster.yml
</span></code></pre></div></div></div><div id="comment"></div><footer><div class="flex flex-col text-sm font-medium sm:flex-row sm:justify-between sm:text-base"><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog/k8s_manifest-SecurityContext">← <!-- -->K8S manifest - SecurityContext</a></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog/ingress-ctrl-baremetal-lb-in-k8s">Hands-On Example: Ingress and Bare Metal Load Balancer in Kubernetes<!-- --> →</a></div></div></footer></div></div></article></div></main><footer><div class="mt-16 flex flex-col items-center"><div class="mb-3 flex space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:demian11k@gmail.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/demian9k"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div><div class="mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>demian11k</div><div> • </div><div>© 2023</div><div> • </div><a href="/">demian11k</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var r=Object.create;var l=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var h=Object.getPrototypeOf,p=Object.prototype.hasOwnProperty;var i=a=\u003el(a,\"__esModule\",{value:!0});var u=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),N=(a,s)=\u003e{i(a);for(var c in s)l(a,c,{get:s[c],enumerable:!0})},k=(a,s,c)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let n of m(s))!p.call(a,n)\u0026\u0026n!==\"default\"\u0026\u0026l(a,n,{get:()=\u003es[n],enumerable:!(c=d(s,n))||c.enumerable});return a},g=a=\u003ek(i(l(a!=null?r(h(a)):{},\"default\",a\u0026\u0026a.__esModule\u0026\u0026\"default\"in a?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a);var t=u((x,o)=\u003e{o.exports=_jsx_runtime});var v={};N(v,{default:()=\u003ef,frontmatter:()=\u003eb});var e=g(t()),b={title:\"Setting up a Kubernetes Cluster using Kubespray on VirtualBox with Ubuntu 22.04\",date:new Date(1685844131e3),lastmod:\"2023-06-04\",tags:[\"kubernetes\",\"ubuntu\",\"virtualbox\"],draft:!1,summary:\"\",layout:\"PostSimple\",canonicalUrl:\"https://demian9k.github.io/blog/set-up-k8s-cluster-kubespray-on-virtualbox-ubuntu2204/\"};function y(a={}){let{wrapper:s}=a.components||{};return s?(0,e.jsx)(s,Object.assign({},a,{children:(0,e.jsx)(c,{})})):c();function c(){let n=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",h4:\"h4\",ul:\"ul\",li:\"li\",p:\"p\",h3:\"h3\",pre:\"pre\",code:\"code\",br:\"br\"},a.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"step1-vm-network-setup\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#step1-vm-network-setup\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Step1. VM network setup\"]}),(0,e.jsxs)(n.h4,{id:\"configure-virtualbox-host-only-network-cidr-manual\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#configure-virtualbox-host-only-network-cidr-manual\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Configure VirtualBox host-only network CIDR (manual)\"]}),(0,e.jsx)(n.ul,{children:(0,e.jsx)(n.li,{children:\"192.168.100.0/24\"})}),(0,e.jsxs)(n.h4,{id:\"\\uD074\\uB7EC\\uC2A4\\uD130-\\uB178\\uB4DC\\uAC00-\\uB420-\\uD638\\uC2A4\\uD2B8-\\uBAA9\\uB85D\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#\\uD074\\uB7EC\\uC2A4\\uD130-\\uB178\\uB4DC\\uAC00-\\uB420-\\uD638\\uC2A4\\uD2B8-\\uBAA9\\uB85D\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\uD074\\uB7EC\\uC2A4\\uD130 \\uB178\\uB4DC\\uAC00 \\uB420 \\uD638\\uC2A4\\uD2B8 \\uBAA9\\uB85D\"]}),(0,e.jsxs)(n.ul,{children:[(0,e.jsx)(n.li,{children:\"myclusternode01\"}),(0,e.jsx)(n.li,{children:\"myclusternode02\"}),(0,e.jsx)(n.li,{children:\"myclusternode03\"})]}),(0,e.jsx)(n.p,{children:\"\\uAC01 host\\uB4E4\\uC740 \\uCCAB\\uBC88\\uC9F8 nic\\uB294 DHCP\\uB97C \\uC0AC\\uC6A9\\uD55C NAT\\uAC00 \\uC801\\uC6A9\\uB41C \\uAC83\\uC744 \\uC0AC\\uC6A9\\uD55C\\uB2E4.\"}),(0,e.jsx)(n.p,{children:\"\\uB450\\uBC88\\uC9F8 NIC\\uB294 host-only nic ip\\uB97C \\uAC16\\uB294\\uB2E4. \\uC544\\uB798 \\uB0B4\\uC6A9\\uC740 /etc/hosts \\uD30C\\uC77C\\uC5D0 \\uB4F1\\uB85D\\uB41C\\uB2E4.\"}),(0,e.jsx)(n.p,{children:\"windows host-only network\\uC758 nic\\uB294 192.168.100.100 \\uC73C\\uB85C \\uC124\\uC815\\uD558\\uC5EC windows host\\uC5D0\\uC11C \\uAC01 myclusternode \\uC758 host-only \\uB124\\uD2B8\\uC6CC\\uD06C\\uC5D0 \\uC5F0\\uACB0\\uD560 \\uC218 \\uC788\\uB3C4\\uB85D \\uD55C\\uB2E4.\"}),(0,e.jsxs)(n.h2,{id:\"step2-setup-hosts\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#step2-setup-hosts\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Step2. Setup hosts\"]}),(0,e.jsxs)(n.h3,{id:\"register-hostnames\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#register-hostnames\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"register hostnames\"]}),(0,e.jsx)(n.p,{children:\"\\uAC01 \\uD638\\uC2A4\\uD2B8\\uB4E4\\uC744 \\uC774\\uB984\\uC73C\\uB85C \\uC2DD\\uBCC4\\uD558\\uB3C4\\uB85D hosts\\uC5D0 \\uB4F1\\uB85D\\uD55C\\uB2E4. \\uBAA8\\uB4E0 \\uD638\\uC2A4\\uD2B8\\uC5D0 \\uB4F1\\uB85D\\uB418\\uC5B4\\uC57C \\uD55C\\uB2E4.\"}),(0,e.jsx)(\"div\",{className:\"remark-code-title\",children:\"/etc/hosts\"}),(0,e.jsx)(n.pre,{children:(0,e.jsxs)(n.code,{className:\"code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`192.168.100.1 myclusternode01\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`192.168.100.2 myclusternode02\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`192.168.100.3 myclusternode03\n`})]})}),(0,e.jsxs)(n.h3,{id:\"sudoers\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#sudoers\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"sudoers\"]}),(0,e.jsx)(n.p,{children:\"sudo \\uBA85\\uB839\\uC5B4 \\uC0AC\\uC6A9\\uC2DC \\uBE44\\uBC00\\uBC88\\uD638\\uB97C \\uC785\\uB825\\uD558\\uC9C0 \\uC54A\\uB3C4\\uB85D sudoers \\uC124\\uC815\\uC744 \\uD55C\\uB2E4.\"}),(0,e.jsx)(\"div\",{className:\"remark-code-title\",children:\"/etc/sudoers\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"demian \",(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"ALL\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"ALL\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),` NOPASSWD:ALL\n`]})})}),(0,e.jsxs)(n.h3,{id:\"netplan\\uC5D0\\uC11C-static-ip-\\uC124\\uC815\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#netplan\\uC5D0\\uC11C-static-ip-\\uC124\\uC815\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"netplan\\uC5D0\\uC11C static ip \\uC124\\uC815\"]}),(0,e.jsx)(\"div\",{className:\"remark-code-title\",children:\"/etc/netplan/00-installer-config.yaml\"}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"network\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"ethernets\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enp0s3\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"dhcp4\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"true\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# NAT\\uB97C \\uC0AC\\uC6A9\\uD574 \\uD638\\uC2A4\\uD2B8\\uC758 \\uC778\\uD130\\uB137 \\uC5F0\\uACB0\\uC744 \\uC0AC\\uC6A9\\uD560 \\uC218 \\uC788\\uB3C4\\uB85D \\uC124\\uC815\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enp0s8\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"addresses\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` 192.168.100.1/24\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"nameservers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"addresses\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"8.8.8.8\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" 8.8.4.4\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"version\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),`\n`]})]})}),(0,e.jsxs)(n.h3,{id:\"change-apt-sources-url\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#change-apt-sources-url\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"change APT sources url\"]}),(0,e.jsx)(n.p,{children:\"\\uB354 \\uBE60\\uB978 \\uC758\\uC874\\uC131 \\uD30C\\uC77C \\uB2E4\\uC6B4\\uB85C\\uB4DC\\uB97C \\uC704\\uD574 \\uAE30\\uBCF8\\uAC12 apt source list\\uB97C \\uBCC0\\uACBD\\uD55C\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsx)(n.code,{className:\"language-bash code-highlight\",children:(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"sudo\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"sed\"}),\" -i \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'s/kr.archive.ubuntu.com/mirror.kakao.com/g'\"}),` /etc/apt/sources.list\n`]})})}),(0,e.jsxs)(n.h3,{id:\"setup-ansible-dependencies\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#setup-ansible-dependencies\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"setup ansible dependencies\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"apt\"}),` update\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"apt\"}),` upgrade\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# python3 \\uC124\\uCE58\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"sudo\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"apt\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"install\"}),` python3-pip python3-setuptools python3-virtualenv -y\n`]})]})}),(0,e.jsxs)(n.h3,{id:\"configure-os-environment\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#configure-os-environment\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"configure OS environment\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# swap memory \\uB044\\uAE30\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"sudo\"}),` swapoff -a\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# \\uD30C\\uC77C\\uC2DC\\uC2A4\\uD15C \\uD14C\\uC774\\uBE14(/etc/fstab) \\uC5D0\\uC11C swap \\uAD00\\uB828 \\uBB38\\uC790\\uC5F4\\uC744 \\uC0AD\\uC81C\\uD558\\uC5EC swap \\uAD00\\uB828 \\uAE30\\uB2A5\\uC744 disable \\uD55C\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"sudo\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"sed\"}),\" -i \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'/swap/d'\"}),` /etc/fstab\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# \\uBC29\\uD654\\uBCBD disable\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`systemctl stop ufw\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`systemctl disable ufw\n`})]})}),(0,e.jsx)(\"hr\",{}),(0,e.jsxs)(n.p,{children:[\"\\uC774\\uD6C4 \\uACFC\\uC815\\uC740 \\uAC01 vm\\uC744 virtualbox\\uC5D0\\uC11C \\uBCF5\\uC81C \\uD6C4 myclusternode02, myclusternode03\\uC73C\\uB85C \\uBCF5\\uC81C\\uD6C4 \\uC9C4\\uD589\\uD55C\\uB2E4.\",(0,e.jsx)(n.br,{}),\"\\uBCF5\\uC81C\\uC2DC NIC\\uC758 Mac address\\uB294 \\uC0C8\\uB85C \\uC0DD\\uC131\\uD558\\uB3C4\\uB85D \\uC635\\uC158\\uC744 \\uC8FC\\uC5C8\\uB2E4.\"]}),(0,e.jsxs)(n.h3,{id:\"change-node-ips-on-duplicated-vms\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#change-node-ips-on-duplicated-vms\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"change node IPs on duplicated VMs\"]}),(0,e.jsx)(n.p,{children:\"\\uBCF5\\uC81C\\uB41C vm\\uC758 netplan config\\uC758 network.ethernets.enp0s8.addresses\\uC5D0 \\uD638\\uC2A4\\uD2B8 \\uBAA9\\uB85D\\uC5D0\\uC11C \\uC815\\uC758\\uD55C ip\\uC5D0 \\uB9DE\\uB3C4\\uB85D \\uC124\\uC815\\uC744 \\uBCC0\\uACBD\\uD55C\\uB2E4.\"}),(0,e.jsx)(\"div\",{className:\"remark-code-title\",children:\"/etc/netplan/00-installer-config.yaml\"}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"network\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"ethernets\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enp0s3\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"dhcp4\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"true\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"enp0s8\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"addresses\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"-\"}),` 192.168.100.1/24\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# - 192.168.100.2/24  # myclusternode02\\uC758 \\uACBD\\uC6B0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# - 192.168.100.3/24  # myclusternode03\\uC758 \\uACBD\\uC6B0\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"      \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"nameservers\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"addresses\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"8.8.8.8\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" 8.8.4.4\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"version\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"2\"}),`\n`]})]})}),(0,e.jsxs)(n.h3,{id:\"change-hostname-on-duplicated-vms\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#change-hostname-on-duplicated-vms\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"change hostname on duplicated VMs\"]}),(0,e.jsx)(n.p,{children:\"\\uC544\\uB798 \\uB0B4\\uC6A9\\uC740 \\uBCF5\\uC81C\\uB41C \\uAC01 \\uD638\\uC2A4\\uD2B8\\uC5D0\\uC11C \\uC2E4\\uD589\\uD55C\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"sudo\"}),` hostnamectl set-hostname myclusternode02\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"sudo\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"sed\"}),\" -i \",(0,e.jsx)(n.span,{className:\"token string\",children:\"'s/myclusternode01/myclusternode02/g'\"}),` /etc/hosts\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"#\\uBCC0\\uACBD \\uD655\\uC778\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"cat\"}),` /etc/hostname\n`]})]})}),(0,e.jsxs)(n.h3,{id:\"generate-ssh-credentials\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#generate-ssh-credentials\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"generate ssh credentials\"]}),(0,e.jsx)(n.p,{children:\"\\uC544\\uB798 \\uB0B4\\uC6A9\\uC740 \\uBAA8\\uB4E0 \\uD638\\uC2A4\\uD2B8\\uC5D0\\uC11C \\uC2E4\\uD589\\uD55C\\uB2E4.\"}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsx)(n.span,{className:\"code-line\",children:`ssh-keygen -t ed25519\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# \\uAC01 \\uD638\\uC2A4\\uD2B8\\uC5D0 ssh\\uB97C \\uC774\\uC6A9\\uD558\\uC5EC \\uC811\\uC18D\\uD560 \\uC218 \\uC788\\uB3C4\\uB85D credentials\\uB97C \\uBCF5\\uC0AC\\uD55C\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# ssh node02  \\uC774\\uB7F0 \\uBC29\\uC2DD\\uC73C\\uB85C \\uBE60\\uB974\\uAC8C \\uC811\\uC18D \\uAC00\\uB2A5\\uD558\\uAC8C \\uB41C\\uB2E4.\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`ssh-copy-id myclusternode01\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`ssh-copy-id myclusternode02\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`ssh-copy-id myclusternode03\n`})]})}),(0,e.jsxs)(n.h2,{id:\"step3-setup-cluster-using-kubespray\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#step3-setup-cluster-using-kubespray\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Step3. setup cluster using kubespray\"]}),(0,e.jsx)(n.p,{children:\"\\uC544\\uB798 \\uD56D\\uBAA9\\uC740 control-plane \\uB178\\uB4DC \\uC911 \\uD55C \\uACF3\\uC5D0\\uC11C \\uC2E4\\uD589\\uD55C\\uB2E4.\"}),(0,e.jsxs)(n.h3,{id:\"setup-kubespray-dependencies\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#setup-kubespray-dependencies\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"setup kubespray dependencies\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"git\"}),` clone -b release-2.22 --single-branch https://github.com/kubernetes-sigs/kubespray\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# https://github.com/kubernetes-sigs/kubespray/blob/master/docs/ansible.md#installing-ansible\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"VENVDIR\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),`kubespray-venv\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"KUBESPRAYDIR\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),`kubespray\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"ANSIBLE_VERSION\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"2.12\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"# \\uC564\\uC11C\\uBE14 \\uBC84\\uC804\\uC740 python 2.7,3.5-3.9 \\uC774\\uBA74 2.11, 3.8 \\uC704\\uB85C\\uB294 2.12\\uC774 Compatibility\\uAC00 \\uC788\\uB2E4\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"virtualenv  --python\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsxs)(n.span,{className:\"token variable\",children:[(0,e.jsx)(n.span,{className:\"token variable\",children:\"$(\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"which\"}),\" python3\",(0,e.jsx)(n.span,{className:\"token variable\",children:\")\"})]}),\" \",(0,e.jsx)(n.span,{className:\"token variable\",children:\"$VENVDIR\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\"source\"}),\" \",(0,e.jsx)(n.span,{className:\"token variable\",children:\"$VENVDIR\"}),`/bin/activate\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\"cd\"}),\" \",(0,e.jsx)(n.span,{className:\"token variable\",children:\"$KUBESPRAYDIR\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"pip \",(0,e.jsx)(n.span,{className:\"token function\",children:\"install\"}),\" -U -r requirements-\",(0,e.jsx)(n.span,{className:\"token variable\",children:\"$ANSIBLE_VERSION\"}),`.txt\n`]})]})}),(0,e.jsxs)(n.h3,{id:\"building-ansible-inventory-file\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#building-ansible-inventory-file\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"building ansible inventory file\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Copy ``inventory/sample`` as ``inventory/mycluster``\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# sample \\uC778\\uBCA4\\uD1A0\\uB9AC \\uD15C\\uD50C\\uB9BF\\uC744 \\uBCF5\\uC0AC\\uD55C\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"cp\"}),` -rfp inventory/sample inventory/mycluster\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Update Ansible inventory file with inventory builder\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# IPS\\uB85C \\uC9C0\\uC815\\uD55C host ip \\uBAA9\\uB85D\\uC744 \\uB9E4\\uAC1C\\uBCC0\\uC218\\uB85C \\uC778\\uBCA4\\uD1A0\\uB9AC \\uBE4C\\uB354\\uB97C \\uC2E4\\uD589\\uD558\\uC5EC hosts.yaml \\uD30C\\uC77C\\uC744 \\uB9CC\\uB4E0\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# (hosts.yaml \\uD30C\\uC77C\\uC740 sample \\uC778\\uBCA4\\uD1A0\\uB9AC \\uD15C\\uD50C\\uB9BF\\uC5D4 \\uC874\\uC7AC\\uD558\\uC9C4 \\uC54A\\uB294\\uB2E4.)\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# HOST_PREFIX\\uB294 \\uB178\\uB4DC \\uBC88\\uD638 \\uC55E\\uC5D0 \\uBD99\\uC77C \\uC774\\uB984\\uC744 \\uC758\\uBBF8\\uD55C\\uB2E4. \\uC544\\uB798 \\uC774\\uB984\\uCC98\\uB7FC \\uC124\\uC815\\uD558\\uBA74\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# myclusternode1, myclusternode2, myclusternode3 \\uCC98\\uB7FC cluster node \\uC774\\uB984\\uACFC \\uAC01 \\uD638\\uC2A4\\uD2B8\\uC758 hostname\\uC774 \\uBCC0\\uACBD\\uB41C\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# \\uAE30\\uC874 hostname\\uC744 \\uADF8\\uB300\\uB85C \\uC0AC\\uC6A9\\uD558\\uB824\\uBA74 USE_REAL_HOSTNAME=true \\uB85C \\uBCC0\\uC218\\uB97C set\\uD55C\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# KUBE_CONTROL_HOSTS \\uAC12\\uC740 \\uC124\\uCE58\\uD558\\uB294 \\uB178\\uB4DC \\uC911 \\uBA87 \\uAC1C\\uB97C control-plane\\uC73C\\uB85C \\uC0AC\\uC6A9\\uD560 \\uAC83\\uC778\\uC9C0\\uB97C \\uACB0\\uC815\\uD558\\uB294 \\uBCC0\\uC218\\uC774\\uBA70, \\uAE30\\uBCF8\\uAC12\\uC740 2\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token builtin class-name\",children:\"declare\"}),\" -a \",(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"IPS\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token number\",children:\"192.168\"}),\".100.1 \",(0,e.jsx)(n.span,{className:\"token number\",children:\"192.168\"}),\".100.2 \",(0,e.jsx)(n.span,{className:\"token number\",children:\"192.168\"}),\".100.3\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"HOST_PREFIX\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"myclusternode \",(0,e.jsx)(n.span,{className:\"token variable assign-left\",children:\"CONFIG_FILE\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\"inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py \",(0,e.jsxs)(n.span,{className:\"token variable\",children:[\"${IPS\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"[\"}),\"@\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"]\"}),\"}\"]}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# debug \\uBAA8\\uB4DC\\uAC00 \\uAE30\\uBCF8\\uAC12\\uC73C\\uB85C \\uCF1C\\uC838 \\uC788\\uC5B4 \\uC544\\uB798\\uCC98\\uB7FC \\uC5B4\\uB5A4 \\uAC12\\uB4E4\\uC774 hosts.yaml\\uC5D0 \\uCD94\\uAC00\\uB418\\uB294\\uC9C0 stdout \\uB41C\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: Adding group all\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: Adding group kube_control_plane\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: Adding group kube_node\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: Adding group etcd\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: Adding group k8s_cluster\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: Adding group calico_rr\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode1 to group all\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode2 to group all\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode3 to group all\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode1 to group etcd\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode2 to group etcd\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode3 to group etcd\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode1 to group kube_control_plane\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode2 to group kube_control_plane\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode1 to group kube_node\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode2 to group kube_node\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# DEBUG: adding host myclusternode3 to group kube_node\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Review and change parameters under ``inventory/mycluster/group_vars``\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"cat\"}),` inventory/mycluster/group_vars/all/all.yml\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"cat\"}),` inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml\n`]})]})}),(0,e.jsxs)(n.h3,{id:\"setting-kubespray-inventory-variable\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#setting-kubespray-inventory-variable\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"setting kubespray inventory variable\"]}),(0,e.jsx)(\"div\",{className:\"remark-code-title\",children:\"inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml\"}),(0,e.jsx)(n.pre,{className:\"language-yaml\",children:(0,e.jsxs)(n.code,{className:\"code-highlight language-yaml\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# configure arp_ignore and arp_announce to avoid answering ARP queries from kube-ipvs0 interface\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# must be set to true for MetalLB to work\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"#METAL_LB \\uC0AC\\uC6A9 \\uC608\\uC815\\uC774\\uBBC0\\uB85C true\\uB85C \\uBCC0\\uACBD\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kube_proxy_strict_arp\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"true\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"## docker for docker, crio for cri-o and containerd for containerd.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"container_manager\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),` containerd\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# audit log for kubernetes\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token atrule key\",children:\"kubernetes_audit\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token boolean important\",children:\"true\"}),`\n`]})]})}),(0,e.jsxs)(n.h3,{id:\"run-playbook-to-install-k8s-cluster\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",href:\"#run-playbook-to-install-k8s-cluster\",tabIndex:\"-1\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"run playbook to install k8s cluster\"]}),(0,e.jsx)(n.pre,{className:\"language-bash\",children:(0,e.jsxs)(n.code,{className:\"language-bash code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Clean up old Kubernete cluster with Ansible Playbook - run the playbook as root\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# The option `--become` is required, as for example cleaning up SSL keys in /etc/,\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# uninstalling old packages and interacting with various systemd daemons.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Without --become the playbook will fail to run!\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# And be mind it will remove the current kubernetes cluster (if it's running)!\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# \\uC774\\uC804\\uC5D0 \\uC124\\uCE58\\uD55C \\uD754\\uC801\\uC744 \\uC0AD\\uC81C\\uD558\\uAE30 \\uC704\\uD574 hosts.yaml\\uC758 \\uD638\\uC2A4\\uD2B8 \\uBAA9\\uB85D\\uC744 \\uB300\\uC0C1\\uC73C\\uB85C reset playbook\\uC744 \\uC2E4\\uD589\\uD55C\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"ansible-playbook -i inventory/mycluster/hosts.yaml  --become --become-user\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),`root reset.yml\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Deploy Kubespray with Ansible Playbook - run the playbook as root\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# The option `--become` is required, as for example writing SSL keys in /etc/,\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# installing packages and interacting with various systemd daemons.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# Without --become the playbook will fail to run!\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"# hosts.yaml\\uC758 \\uD638\\uC2A4\\uD2B8 \\uBAA9\\uB85D\\uC744 \\uB300\\uC0C1\\uC73C\\uB85C cluster\\uB97C \\uC124\\uCE58\\uD558\\uAE30 \\uC704\\uD574 cluster playbook\\uC744 \\uC2E4\\uD589\\uD55C\\uB2E4.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"ansible-playbook -i inventory/mycluster/hosts.yaml  --become --become-user\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),`root cluster.yml\n`]})]})})]})}}var f=y;return v;})();\n;return Component;","toc":[{"value":"Step1. VM network setup","url":"#step1-vm-network-setup","depth":2},{"value":"Configure VirtualBox host-only network CIDR (manual)","url":"#configure-virtualbox-host-only-network-cidr-manual","depth":4},{"value":"클러스터 노드가 될 호스트 목록","url":"#클러스터-노드가-될-호스트-목록","depth":4},{"value":"Step2. Setup hosts","url":"#step2-setup-hosts","depth":2},{"value":"register hostnames","url":"#register-hostnames","depth":3},{"value":"sudoers","url":"#sudoers","depth":3},{"value":"netplan에서 static ip 설정","url":"#netplan에서-static-ip-설정","depth":3},{"value":"change APT sources url","url":"#change-apt-sources-url","depth":3},{"value":"setup ansible dependencies","url":"#setup-ansible-dependencies","depth":3},{"value":"configure OS environment","url":"#configure-os-environment","depth":3},{"value":"change node IPs on duplicated VMs","url":"#change-node-ips-on-duplicated-vms","depth":3},{"value":"change hostname on duplicated VMs","url":"#change-hostname-on-duplicated-vms","depth":3},{"value":"generate ssh credentials","url":"#generate-ssh-credentials","depth":3},{"value":"Step3. setup cluster using kubespray","url":"#step3-setup-cluster-using-kubespray","depth":2},{"value":"setup kubespray dependencies","url":"#setup-kubespray-dependencies","depth":3},{"value":"building ansible inventory file","url":"#building-ansible-inventory-file","depth":3},{"value":"setting kubespray inventory variable","url":"#setting-kubespray-inventory-variable","depth":3},{"value":"run playbook to install k8s cluster","url":"#run-playbook-to-install-k8s-cluster","depth":3}],"frontMatter":{"readingTime":{"text":"6 min read","minutes":5.495,"time":329700,"words":1099},"slug":"set-up-k8s-cluster-kubespray-on-virtualbox-ubuntu2204","fileName":"set-up-k8s-cluster-kubespray-on-virtualbox-ubuntu2204.mdx","title":"Setting up a Kubernetes Cluster using Kubespray on VirtualBox with Ubuntu 22.04","date":"2023-06-04T02:02:11.000Z","lastmod":"2023-06-04","tags":["kubernetes","ubuntu","virtualbox"],"draft":false,"summary":"","layout":"PostSimple","canonicalUrl":"https://demian9k.github.io/blog/set-up-k8s-cluster-kubespray-on-virtualbox-ubuntu2204/"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.155,"time":9300,"words":31},"slug":["default"],"fileName":"default.md","name":"demian11k","avatar":"/static/images/avatar.png","email":"demian11k@gmail.com","github":"https://github.com/demian9k","date":null}],"prev":{"title":"K8S manifest - SecurityContext","date":"2023-06-02T02:03:00.000Z","lastmod":"2023-06-02","tags":["kubernetes"],"draft":false,"summary":"","layout":"PostSimple","slug":"k8s_manifest-SecurityContext"},"next":{"title":"Hands-On Example: Ingress and Bare Metal Load Balancer in Kubernetes","date":"2023-06-05T00:00:00.000Z","lastmod":"2023-06-05","tags":["Kubernetes","Ingress","LoadBalancer"],"draft":false,"summary":"","layout":"PostSimple","canonicalUrl":"https://demian9k.github.io/blog/ingress-ctrl-baremetal-lb-in-k8s/","slug":"ingress-ctrl-baremetal-lb-in-k8s"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["set-up-k8s-cluster-kubespray-on-virtualbox-ubuntu2204"]},"buildId":"otfPwKwSsy3CYkkcjSJd6","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>